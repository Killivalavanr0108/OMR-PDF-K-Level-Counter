<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OMR PDF K-Level Counter</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: "Poppins", sans-serif;
    color: white; overflow-x: hidden;
  }

  /* üé• Background */
  .video-bg {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: -2; overflow: hidden;
  }

  .video-bg video {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    min-width: 100%; min-height: 100%;
    object-fit: cover; filter: brightness(0.7) blur(1px);
  }

  .overlay {
    position: fixed; top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: -1;
  }

  /* Main */
  .content {
    position: relative; z-index: 1;
    display: flex; flex-direction: column;
    align-items: center;
    padding: 40px 10px;
  }

  h1 {
    color: #00eaff;
    text-shadow: 0 0 15px #00eaff;
    margin-bottom: 20px;
  }

  .college-header {
    display: flex; align-items: center; justify-content: center;
    background: rgba(0,170,255,0.15);
    padding: 15px; border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,200,255,0.3);
    width: 90%; max-width: 700px;
    flex-wrap: wrap;
  }

  .college-header img {
    height: 80px; border-radius: 10px; margin-right: 15px;
  }

  .upload-box {
    margin-top: 30px; text-align: center;
    padding: 30px; width: 90%; max-width: 460px;
    border: 2px dashed #00eaff; border-radius: 10px;
    background: rgba(0,230,255,0.08);
    box-shadow: 0 0 20px rgba(0,238,255,0.3);
  }

  input[type=file] { margin-top: 10px; }

  #status, #student-info, #results {
    background: rgba(255,255,255,0.08);
    padding: 20px; margin: 20px auto;
    width: 90%; max-width: 600px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,200,255,0.2);
  }

  table {
    width: 100%; border-collapse: collapse;
  }

  th, td {
    border: 1px solid rgba(0,238,255,0.3);
    padding: 8px; text-align: center;
  }

  th { background: rgba(0,238,255,0.2); }

  .answered { color: #00ff9d; font-weight: bold; }
  .unanswered { color: #ff4b4b; font-weight: bold; }
</style>
</head>
<body>
  <!-- üé• Background -->
  <div class="video-bg">
    <video autoplay muted loop playsinline>
      <source src="Animation video.mp4" type="video/mp4">
    </video>
  </div>
  <div class="overlay"></div>

  <div class="content">
    <div class="college-header">
      <img src="college_token.avif" alt="College Logo">
      <h2>Government Arts College, Nandanam, Chennai-35</h2>
    </div>

    <h1>OMR PDF K-Level Counter</h1>

    <div class="upload-box">
      <p>Select a <b>.pdf</b> file:</p>
      <input type="file" id="fileInput" accept=".pdf">
    </div>

    <div id="status"></div>
    <div id="student-info"></div>
    <div id="results"></div>
  </div>

<script>
document.getElementById("fileInput").addEventListener("change", handleFile);

async function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  setStatus("‚è≥ Processing file...");
  setStudentInfo(""); setResults("");

  try {
    const text = await extractTextFromPDF(file);
    const info = extractStudentInfo(text);
    const result = countKLevels(text);

    // --- Student Info Display ---
    let infoHTML = "<h3>Student Information</h3><table>";
    infoHTML += `<tr><td><b>Name</b></td><td>${info.studentName||"Not Found"}</td></tr>`;
    infoHTML += `<tr><td><b>Register No</b></td><td>${info.regNo||"Not Found"}</td></tr>`;
    infoHTML += `<tr><td><b>Department</b></td><td>${info.department||"Not Found"}</td></tr>`;
    infoHTML += `<tr><td><b>Subject</b></td><td>${info.subjectName||"Not Found"}</td></tr>`;
    infoHTML += `<tr><td><b>Subject Code</b></td><td>${info.subjectCode||"Not Found"}</td></tr>`;
    infoHTML += "</table>";
    setStudentInfo(infoHTML);

    // --- K-Level Counts ---
    let resHTML = "<h3>K-Level Counts</h3><table><tr><th>K-Level</th><th>Count</th></tr>";
    for (let k=1;k<=6;k++) resHTML += `<tr><td>K${k}</td><td>${result.counts[`K${k}`]}</td></tr>`;
    resHTML += `<tr><td><b>Total Answered</b></td><td>${result.total}</td></tr>`;
    resHTML += `<tr><td><b>Unanswered</b></td><td>${result.unanswered}</td></tr>`;
    resHTML += `<tr><td><b>Total Questions</b></td><td>${result.details.length}</td></tr>`;
    resHTML += "</table><br><h3>Question Details</h3><ul>";

    result.details.forEach((d,i)=>{
      resHTML += `<li>Q${i+1}: ${d.pickedK ? `<span class='answered'>${d.pickedK}</span>` : `<span class='unanswered'>Unanswered ‚ùå</span>`}</li>`;
    });
    resHTML += "</ul>";
    setResults(resHTML);

    setStatus("‚úÖ Completed successfully!");
  } catch (err) {
    setStatus("‚ùå Error: " + err.message);
  }
}

function setStatus(m){document.getElementById("status").innerText=m;}
function setResults(h){document.getElementById("results").innerHTML=h;}
function setStudentInfo(h){document.getElementById("student-info").innerHTML=h;}

/* ---- PDF TEXT EXTRACTION ---- */
async function extractTextFromPDF(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise;
  let text="";
  for(let i=1;i<=pdf.numPages;i++){
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(i=>i.str).join(" ") + "\n";
  }
  return text.replace(/\s+/g," ");
}

/* ---- Extract Student Info ---- */
function extractStudentInfo(t){
  return {
    studentName: (t.match(/Student\s*Name[:.\- ]+([A-Za-z .]+)/i)||[])[1],
    regNo: (t.match(/Register\s*No[:.\- ]+([A-Za-z0-9]+)/i)||[])[1],
    department: (t.match(/Department[:.\- ]+([A-Za-z0-9 .]+)/i)||[])[1],
    subjectName: (t.match(/Subject\s*Name[:.\- ]+([A-Za-z0-9 .]+)/i)||[])[1],
    subjectCode: (t.match(/Subject\s*Code[:.\- ]+([A-Za-z0-9]+)/i)||[])[1],
  };
}

/* ---- Count K-Levels ---- */
function countKLevels(text){
  const counts={K1:0,K2:0,K3:0,K4:0,K5:0,K6:0};
  const qRegex=/(\d+)\s*\((.*?)\)\s*\((.*?)\)\s*\((.*?)\)\s*\((.*?)\)\s*\((.*?)\)\s*\((.*?)\)/g;
  const details=[]; let m;
  while((m=qRegex.exec(text))!==null){
    const q=m[1], choices=m.slice(2,8);
    const picked=choices.findIndex(c=>c.includes("‚óè"));
    if(picked>=0) counts[`K${picked+1}`]++;
    details.push({q,pickedK:picked>=0?`K${picked+1}`:null});
  }
  const total=Object.values(counts).reduce((a,b)=>a+b,0);
  const unanswered=details.filter(d=>!d.pickedK).length;
  return {counts,total,unanswered,details};
}
</script>
</body>
</html>
