<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K-Level Counter</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table, th, td { border: 1px solid #333; border-collapse: collapse; padding: 8px; text-align: center; }
  table { width: 100%; margin-top: 20px; }
  hr { margin: 30px 0; }
</style>
</head>
<body>

<h1>K-Level Counter</h1>
<input type="file" id="excelFile" accept=".xlsx, .xls" />
<button onclick="processExcel()">Process</button>
<div id="results"></div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
let data = [];

function processExcel() {
    const fileInput = document.getElementById('excelFile');
    if (!fileInput.files.length) { alert("Please select an Excel file."); return; }

    const reader = new FileReader();
    reader.onload = function(e) {
        const dataBinary = new Uint8Array(e.target.result);
        const workbook = XLSX.read(dataBinary, {type: "array"});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(firstSheet, {defval: 0});
        if(data.length === 0) { alert("Excel file is empty or invalid."); return; }
        displayResults();
    };
    reader.readAsArrayBuffer(fileInput.files[0]);
}

function displayResults() {
    const resultsDiv = document.getElementById('results');
    let html = "";

    const kLevels = ["K1","K2","K3","K4","K5","K6"];

    // Student Details Table
    const columns = ["S.No","Name","Reg.no","Subject","Subject Code"].concat(kLevels);
    html += "<h3>Student Details</h3><table><tr>";
    columns.forEach(col => html += `<th>${col}</th>`);
    html += "</tr>";

    data.forEach(student => {
        html += "<tr>";
        columns.forEach(col => html += `<td>${student[col] || 0}</td>`);
        html += "</tr>";
    });
    html += "</table>";

    // Initialize totals and counts
    let kTotals = {}, kAnsweredCount = {};
    kLevels.forEach(k => { kTotals[k]=0; kAnsweredCount[k]=0; });

    data.forEach(student => {
        kLevels.forEach(k => {
            const val = Number(student[k] || 0);
            kTotals[k] += val;
            if(val > 0) kAnsweredCount[k]++;  // Count of students who answered this K level
        });
    });

    // Display Per K-Level Totals
    html += "<h3>Per K-Level Total and Students Answered</h3><table><tr>";
    kLevels.forEach(k => html += `<th>${k} Total</th>`);
    kLevels.forEach(k => html += `<th>${k} Students Answered</th>`);
    html += "</tr><tr>";
    kLevels.forEach(k => html += `<td>${kTotals[k]}</td>`);
    kLevels.forEach(k => html += `<td>${kAnsweredCount[k]}</td>`);
    html += "</tr></table>";

    // Display Per K-Level Average (Total / Students Answered)
    html += "<h3>Per K-Level Average (Total / Students Answered)</h3><table><tr>";
    kLevels.forEach(k => html += `<th>${k} Average</th>`);
    html += "</tr><tr>";
    kLevels.forEach(k => {
        const avg = kAnsweredCount[k] ? (kTotals[k] / kAnsweredCount[k]).toFixed(2) : 0;
        html += `<td>${avg}</td>`;
    });
    html += "</tr></table>";

    resultsDiv.innerHTML = html;
}
</script>

</body>
</html>
