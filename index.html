<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OMR PDF / Image / DOCX K-Level Extractor</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>

<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f8f9fa;
    margin: 0;
    padding: 20px;
    color: #333;
  }
  h1 {
    text-align: center;
    color: #0066cc;
  }
  .container {
    max-width: 900px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }
  input[type=file] {
    display: block;
    margin: 10px auto;
    padding: 10px;
  }
  #output {
    background: #f0f0f0;
    border-radius: 6px;
    padding: 15px;
    margin-top: 20px;
    white-space: pre-wrap;
  }
  .details {
    background: #e7f3ff;
    border-left: 5px solid #007bff;
    padding: 10px;
    margin-top: 20px;
    border-radius: 6px;
  }
</style>
</head>

<body>
  <div class="container">
    <h1>OMR Reader ‚Äì PDF / Image / DOCX</h1>
    <p>Select a file (.pdf, .jpg, .jpeg, .png, .docx) to extract student details.</p>
    <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.docx">
    <div id="output">No file uploaded yet.</div>
  </div>

<script>
document.getElementById("fileInput").addEventListener("change", handleFile);

async function handleFile(event) {
    const file = event.target.files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    const output = document.getElementById("output");
    output.textContent = "Processing file: " + file.name + " ...";

    let text = "";

    if (ext === "pdf") {
        text = await extractPDF(file);
    } else if (ext === "docx") {
        text = await extractDocx(file);
    } else if (["jpg", "jpeg", "png"].includes(ext)) {
        text = await extractImage(file);
    } else {
        output.textContent = "‚ùå Unsupported file format.";
        return;
    }

    if (text.trim().length === 0) {
        output.textContent = "‚ö†Ô∏è No text detected.";
        return;
    }

    displayText(text);
}

// ========== PDF HANDLING ==========
async function extractPDF(file) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let text = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const pageText = content.items.map(item => item.str).join(" ");
        text += pageText + "\n";
    }

    // If PDF has no extractable text, use OCR fallback
    if (text.trim().length === 0) {
        text = await ocrPDF(file);
    }
    return text;
}

// ========== OCR FALLBACK FOR IMAGE PDF ==========
async function ocrPDF(file) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let fullText = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

        const imgData = canvas.toDataURL("image/png");
        const result = await Tesseract.recognize(imgData, "eng");
        fullText += result.data.text + "\n";
    }

    return fullText;
}

// ========== DOCX HANDLING ==========
async function extractDocx(file) {
    const buffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer: buffer });
    return result.value;
}

// ========== IMAGE HANDLING ==========
async function extractImage(file) {
    const img = URL.createObjectURL(file);
    const result = await Tesseract.recognize(img, "eng");
    return result.data.text;
}

// ========== DISPLAY RESULTS ==========
function displayText(text) {
    const output = document.getElementById("output");
    output.textContent = text;

    // Extract student details
    const college = text.match(/College\s*Name[:.]?\s*(.+)/i);
    const className = text.match(/Class[:.]?\s*(.+)/i);
    const subjectCode = text.match(/Subject\s*Code[:.]?\s*([A-Za-z0-9]+)/i);
    const registerNo = text.match(/Register\s*No[:.]?\s*(\d+)/i);

    // Show extracted details
    output.innerHTML = `<div class="details">
        <h3>üìã Extracted Student Details</h3>
        ${college ? "<b>College:</b> " + college[1].trim() + "<br>" : ""}
        ${className ? "<b>Class:</b> " + className[1].trim() + "<br>" : ""}
        ${subjectCode ? "<b>Subject Code:</b> " + subjectCode[1].trim() + "<br>" : ""}
        ${registerNo ? "<b>Register No:</b> " + registerNo[1].trim() + "<br>" : ""}
    </div>
    <hr><b>Full Extracted Text:</b><br>` + text;
}
</script>
</body>
</html>
