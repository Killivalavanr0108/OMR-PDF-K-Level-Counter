<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OMR K-Level Counter ‚Äì PDF / Image / DOCX</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #eef6fb;
  color: #222;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 900px;
  margin: 30px auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  padding: 25px;
}
h1 {
  color: #0078ff;
  text-align: center;
  margin-bottom: 10px;
}
h2 { color: #333; border-bottom: 2px solid #0078ff33; padding-bottom: 5px; }
input[type=file] {
  display: block;
  margin: 20px auto;
  padding: 10px;
}
#status {
  text-align: center;
  margin-top: 10px;
  color: #555;
  font-weight: 500;
}
#results {
  margin-top: 20px;
}
.details, .kcount {
  background: #f0f8ff;
  padding: 12px;
  border-radius: 8px;
  margin-top: 15px;
}
.kcount table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 8px;
}
.kcount th, .kcount td {
  border: 1px solid #0078ff33;
  padding: 6px;
  text-align: center;
}
.kcount th {
  background: #0078ff11;
}
.answered { color: #00b36b; font-weight: bold; }
.unanswered { color: #ff3b3b; font-weight: bold; }
</style>
</head>

<body>
<div class="container">
  <h1>üìò OMR K-Level Counter</h1>
  <p style="text-align:center;">Upload a <b>PDF, DOCX, or Image</b> to extract student info and count K-Levels.</p>

  <input type="file" id="fileInput" accept=".pdf,.docx,.jpg,.jpeg,.png">
  <div id="status">No file selected yet.</div>
  <div id="results"></div>
</div>

<script>
document.getElementById("fileInput").addEventListener("change", handleFile);

async function handleFile(event) {
  const file = event.target.files[0];
  const ext = file.name.split('.').pop().toLowerCase();
  const status = document.getElementById("status");
  const results = document.getElementById("results");
  status.textContent = "‚è≥ Processing " + file.name + " ...";
  results.innerHTML = "";

  try {
    let text = "";
    if (ext === "pdf") text = await extractFromPDF(file);
    else if (ext === "docx") text = await extractFromDOCX(file);
    else if (["jpg","jpeg","png"].includes(ext)) text = await extractFromImage(file);
    else throw new Error("Unsupported file format");

    if (!text || text.trim().length === 0) {
      throw new Error("No text found. Try clearer scan or text-based PDF.");
    }

    status.textContent = "‚úÖ Extraction Complete!";
    processText(text);
  } catch (err) {
    status.innerHTML = "‚ùå Error: " + err.message;
    console.error(err);
  }
}

// PDF extraction with OCR fallback
async function extractFromPDF(file) {
  const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
  let text = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    text += content.items.map(it => it.str).join(" ") + "\n";
  }
  if (text.trim().length === 0) text = await ocrFromPDF(file);
  return text;
}

// OCR fallback for image-based PDFs
async function ocrFromPDF(file) {
  const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
  let fullText = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const vp = page.getViewport({ scale: 2 });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = vp.width;
    canvas.height = vp.height;
    await page.render({ canvasContext: ctx, viewport: vp }).promise;
    const dataUrl = canvas.toDataURL("image/png");
    const ocr = await Tesseract.recognize(dataUrl, "eng", {
      logger: m => document.getElementById("status").textContent = `üîç OCR Page ${i} ‚Äì ${(m.progress*100)|0}%`
    });
    fullText += ocr.data.text + "\n";
  }
  return fullText;
}

// DOCX extraction
async function extractFromDOCX(file) {
  const buffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer: buffer });
  return result.value;
}

// Image extraction
async function extractFromImage(file) {
  const img = URL.createObjectURL(file);
  const ocr = await Tesseract.recognize(img, "eng", {
    logger: m => document.getElementById("status").textContent = `üîç OCR ${(m.progress*100)|0}%`
  });
  return ocr.data.text;
}

// Process extracted text: student info + K-count
function processText(text) {
  const results = document.getElementById("results");

  // Extract Student Info
  const info = {
    name: (text.match(/Student\s*Name[:.\- ]+([A-Za-z .]+)/i) || [])[1] || "Not Found",
    regNo: (text.match(/Register\s*No[:.\- ]+([A-Za-z0-9]+)/i) || [])[1] || "Not Found",
    dept: (text.match(/Department[:.\- ]+([A-Za-z0-9 .]+)/i) || [])[1] || "Not Found",
    subject: (text.match(/Subject\s*Name[:.\- ]+([A-Za-z0-9 .]+)/i) || [])[1] || "Not Found",
    code: (text.match(/Subject\s*Code[:.\- ]+([A-Za-z0-9]+)/i) || [])[1] || "Not Found"
  };

  // Count K-levels (looks for ‚ÄúK1 ‚óè‚Äù or ‚ÄúK1 ‚úì‚Äù etc.)
  const kCounts = { K1:0, K2:0, K3:0, K4:0, K5:0, K6:0 };
  const qRegex = /Q\s*\d+.*?(K1|K2|K3|K4|K5|K6).*?(‚óè|‚úì|‚úî)/gi;
  let match;
  const details = [];
  while ((match = qRegex.exec(text)) !== null) {
    const k = match[1];
    kCounts[k]++;
    details.push(k);
  }

  const totalAnswered = Object.values(kCounts).reduce((a,b)=>a+b,0);
  const totalQuestions = (text.match(/Q\s*\d+/gi) || []).length;
  const unanswered = Math.max(0, totalQuestions - totalAnswered);

  // Display
  results.innerHTML = `
    <div class="details">
      <h2>üìã Student Information</h2>
      <b>Name:</b> ${info.name}<br>
      <b>Register No:</b> ${info.regNo}<br>
      <b>Department:</b> ${info.dept}<br>
      <b>Subject Name:</b> ${info.subject}<br>
      <b>Subject Code:</b> ${info.code}<br>
    </div>

    <div class="kcount">
      <h2>üßÆ K-Level Counts</h2>
      <table>
        <tr><th>K-Level</th><th>Count</th></tr>
        ${Object.entries(kCounts).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("")}
        <tr><td><b>Total Answered</b></td><td><b>${totalAnswered}</b></td></tr>
        <tr><td><b>Unanswered</b></td><td><b>${unanswered}</b></td></tr>
        <tr><td><b>Total Questions</b></td><td><b>${totalQuestions}</b></td></tr>
      </table>
    </div>

    <div class="kcount">
      <h2>üìù Question-wise Detected</h2>
      ${details.length > 0 ? details.map((k,i)=>`Q${i+1}: <span class='answered'>${k}</span>`).join("<br>") : "<p class='unanswered'>No answers detected.</p>"}
    </div>
  `;
}
</script>
</body>
</html>
