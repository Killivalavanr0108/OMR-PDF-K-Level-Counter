<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K-Level Counter v3 â€“ Smart OMR Analyzer</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
<script async src="https://docs.opencv.org/4.7.0/opencv.js"></script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(to right, #f0f9ff, #e0f7ff);
  padding: 20px;
}
.container {
  max-width: 950px;
  margin: auto;
  background: white;
  border-radius: 14px;
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
  padding: 25px;
}
h1 {
  text-align: center;
  color: #007bff;
}
#fileInput {
  display: block;
  margin: 20px auto;
  padding: 10px;
}
#status {
  text-align: center;
  color: #333;
  font-weight: bold;
  margin-bottom: 10px;
}
.results {
  background: #f8fcff;
  padding: 15px;
  border-radius: 10px;
  margin-top: 15px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  border: 1px solid #007bff33;
  padding: 8px;
  text-align: center;
}
th {
  background: #007bff11;
}
.answered { color: green; font-weight: bold; }
.unanswered { color: red; font-weight: bold; }
canvas {
  display: none;
}
</style>
</head>

<body>
<div class="container">
  <h1>ðŸ§® K-Level Counter â€“ OMR Sheet Analyzer (v3.0)</h1>
  <p style="text-align:center;">Upload an <b>OMR image or PDF</b> to detect answers and count K1â€“K6 levels.</p>
  <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png">
  <div id="status"></div>
  <div id="output" class="results">No file processed yet.</div>
  <canvas id="hiddenCanvas"></canvas>
</div>

<script>
document.getElementById("fileInput").addEventListener("change", handleFile);

async function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  const status = document.getElementById("status");
  const output = document.getElementById("output");
  status.textContent = "â³ Processing " + file.name + " ...";
  output.innerHTML = "";

  try {
    let imageData;
    if (ext === "pdf") {
      imageData = await pdfToImage(file);
    } else if (["jpg", "jpeg", "png"].includes(ext)) {
      imageData = await readImage(file);
    } else {
      throw new Error("Unsupported file type.");
    }

    status.textContent = "ðŸ” Running OCR...";
    const text = await extractText(imageData);

    status.textContent = "ðŸ”¬ Analyzing K-level bubbles...";
    const kCounts = await detectKLevels(imageData);

    status.textContent = "âœ… Done!";
    displayResults(text, kCounts);
  } catch (err) {
    console.error(err);
    status.textContent = "âŒ Error: " + err.message;
  }
}

// PDF â†’ Image
async function pdfToImage(file) {
  const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
  const page = await pdf.getPage(1);
  const viewport = page.getViewport({ scale: 2 });
  const canvas = document.getElementById("hiddenCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = viewport.width;
  canvas.height = viewport.height;
  await page.render({ canvasContext: ctx, viewport: viewport }).promise;
  return canvas.toDataURL("image/png");
}

// Read image file
async function readImage(file) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.readAsDataURL(file);
  });
}

// OCR for text extraction
async function extractText(imageData) {
  const result = await Tesseract.recognize(imageData, "eng", {
    logger: info => {
      document.getElementById("status").textContent = `ðŸ” OCR: ${Math.round(info.progress*100)}%`;
    }
  });
  return result.data.text;
}

// Detect filled bubbles (K1â€“K6)
async function detectKLevels(imageData) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = function() {
      const canvas = document.getElementById("hiddenCanvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      let src = cv.imread(canvas);
      let gray = new cv.Mat();
      let blur = new cv.Mat();
      let binary = new cv.Mat();

      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
      cv.GaussianBlur(gray, blur, new cv.Size(3,3), 0, 0);
      cv.threshold(blur, binary, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU);

      let contours = new cv.MatVector();
      let hierarchy = new cv.Mat();
      cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

      let counts = { K1:0, K2:0, K3:0, K4:0, K5:0, K6:0 };
      let height = img.height;

      for (let i = 0; i < contours.size(); i++) {
        let cnt = contours.get(i);
        let area = cv.contourArea(cnt);
        if (area > 200 && area < 2000) { // filter for bubbles
          let rect = cv.boundingRect(cnt);
          let yRatio = rect.y / height;
          if (yRatio < 0.15) counts.K1++;
          else if (yRatio < 0.30) counts.K2++;
          else if (yRatio < 0.45) counts.K3++;
          else if (yRatio < 0.60) counts.K4++;
          else if (yRatio < 0.75) counts.K5++;
          else counts.K6++;
        }
      }
      src.delete(); gray.delete(); blur.delete(); binary.delete(); contours.delete(); hierarchy.delete();
      resolve(counts);
    };
    img.src = imageData;
  });
}

// Display final results
function displayResults(text, counts) {
  const output = document.getElementById("output");
  const details = {
    name: (text.match(/Student\s*Name[:.]?\s*(.+)/i) || [])[1] || "Not found",
    regNo: (text.match(/Register\s*No[:.]?\s*([A-Za-z0-9]+)/i) || [])[1] || "Not found",
    dept: (text.match(/Department[:.]?\s*(.+)/i) || [])[1] || "Not found",
    subject: (text.match(/Subject\s*Name[:.]?\s*(.+)/i) || [])[1] || "Not found",
    code: (text.match(/Subject\s*Code[:.]?\s*([A-Za-z0-9]+)/i) || [])[1] || "Not found"
  };

  const total = Object.values(counts).reduce((a,b)=>a+b,0);

  output.innerHTML = `
  <h3>ðŸ“‹ Student Details</h3>
  <b>Name:</b> ${details.name}<br>
  <b>Register No:</b> ${details.regNo}<br>
  <b>Department:</b> ${details.dept}<br>
  <b>Subject:</b> ${details.subject}<br>
  <b>Subject Code:</b> ${details.code}<br>
  <hr>
  <h3>ðŸ“Š K-Level Count</h3>
  <table>
    <tr><th>K-Level</th><th>Filled Bubbles</th></tr>
    ${Object.entries(counts).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join('')}
    <tr><td><b>Total</b></td><td><b>${total}</b></td></tr>
  </table>
  `;
}
</script>
</body>
</html>
