<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K-Level Counter (Excel Input)</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table, th, td { border: 1px solid #333; border-collapse: collapse; padding: 8px; text-align: center; }
  table { width: 100%; margin-top: 20px; }
  th { background-color: #f0f0f0; }
  h1, h3 { color: #003366; }
</style>
</head>
<body>

<h1>ðŸ“˜ K-Level Counter Project</h1>
<input type="file" id="excelFile" accept=".xlsx, .xls" />
<button onclick="processExcel()">Process File</button>

<div id="results"></div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
let data = [];

function normalizeKeys(obj) {
  // Normalize column names (trim spaces and lowercase)
  const normalized = {};
  for (let key in obj) {
    const cleanKey = key.trim().toLowerCase();
    normalized[cleanKey] = obj[key];
  }
  return normalized;
}

function processExcel() {
  const fileInput = document.getElementById('excelFile');
  if (!fileInput.files.length) { alert("Please select an Excel file."); return; }

  const reader = new FileReader();
  reader.onload = function(e) {
    const dataBinary = new Uint8Array(e.target.result);
    const workbook = XLSX.read(dataBinary, { type: "array" });
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    let jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: 0 });

    // Normalize keys for consistent column access
    data = jsonData.map(row => normalizeKeys(row));

    if (data.length === 0) { alert("Excel file is empty or invalid."); return; }
    displayResults();
  };
  reader.readAsArrayBuffer(fileInput.files[0]);
}

function displayResults() {
  const resultsDiv = document.getElementById('results');
  let html = "";

  const kLevels = ["k1","k2","k3","k4","k5","k6"];
  const totalStudents = data.length;

  // Student Details Table
  html += "<h3>Student Details</h3>";
  html += `<table><tr>
      <th>S.No</th><th>Name</th><th>Reg.No</th>
      <th>Subject</th><th>Subject Code</th>
      <th>K1</th><th>K2</th><th>K3</th><th>K4</th><th>K5</th><th>K6</th>
    </tr>`;

  data.forEach(student => {
    html += "<tr>";
    html += `<td>${student["s.no"] || student["sno"] || ""}</td>`;
    html += `<td>${student["name"] || ""}</td>`;
    html += `<td>${student["reg.no"] || student["regno"] || ""}</td>`;
    html += `<td>${student["subject"] || student["sudject"] || ""}</td>`;
    html += `<td>${student["subject code"] || ""}</td>`;
    kLevels.forEach(k => html += `<td>${student[k] || 0}</td>`);
    html += "</tr>";
  });
  html += "</table>";

  // Calculate SUM per K-Level
  let kTotals = {};
  kLevels.forEach(k => kTotals[k] = 0);
  data.forEach(student => {
    kLevels.forEach(k => kTotals[k] += Number(student[k] || 0));
  });

  // Display SUM per K-Level
  html += "<h3>K-Level Totals (SUM)</h3><table><tr>";
  kLevels.forEach(k => html += `<th>${k.toUpperCase()}</th>`);
  html += "</tr><tr>";
  kLevels.forEach(k => html += `<td>${kTotals[k]}</td>`);
  html += "</tr></table>";

  // Calculate and display AVERAGE per K-Level
  html += "<h3>K-Level Average (SUM / Total Students)</h3><table><tr>";
  kLevels.forEach(k => html += `<th>${k.toUpperCase()}</th>`);
  html += "</tr><tr>";
  kLevels.forEach(k => {
    const avg = totalStudents ? (kTotals[k] / totalStudents).toFixed(2) : 0;
    html += `<td>${avg}</td>`;
  });
  html += "</tr></table>";

  resultsDiv.innerHTML = html;
}
</script>

</body>
</html>
