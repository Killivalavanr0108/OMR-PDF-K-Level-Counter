<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OMR Reader ‚Äì PDF / Image / DOCX + K-Level Counter</title>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f6f8fb;
  padding: 20px;
  color: #222;
}
.container {
  max-width: 950px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  color: #007bff;
}
input[type=file] {
  display: block;
  margin: 15px auto;
  padding: 10px;
}
#status {
  text-align: center;
  color: #444;
  font-weight: bold;
  margin-top: 10px;
}
.details, .klevel {
  background: #e8f4ff;
  border-left: 5px solid #007bff;
  padding: 10px;
  margin-bottom: 15px;
  border-radius: 8px;
}
.klevel table {
  width: 100%;
  border-collapse: collapse;
}
.klevel th, .klevel td {
  border: 1px solid #007bff33;
  padding: 6px;
  text-align: center;
}
.klevel th {
  background: #007bff11;
}
.answered { color: #00a86b; font-weight: bold; }
.unanswered { color: #ff3b3b; font-weight: bold; }
</style>
</head>

<body>
  <div class="container">
    <h1>üìò OMR Reader ‚Äì PDF / Image / DOCX + K-Level Counter</h1>
    <p style="text-align:center;">Upload a <b>PDF, DOCX, or Image</b> to extract student info and count K-levels.</p>
    <input type="file" id="fileInput" accept=".pdf,.docx,.jpg,.jpeg,.png">
    <div id="status"></div>
    <div id="output">No file uploaded yet.</div>
  </div>

<script>
document.getElementById("fileInput").addEventListener("change", handleFile);

async function handleFile(event) {
    const file = event.target.files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    const status = document.getElementById("status");
    const output = document.getElementById("output");
    status.textContent = "‚è≥ Processing " + file.name + " ...";
    output.textContent = "";

    try {
        let text = "";
        if (ext === "pdf") text = await extractFromPDF(file);
        else if (ext === "docx") text = await extractFromDOCX(file);
        else if (["jpg", "jpeg", "png"].includes(ext)) text = await extractFromImage(file);
        else throw new Error("Unsupported file type.");

        if (!text || text.trim().length === 0) {
            throw new Error("No text detected in file. Try uploading a clearer image or text-based PDF.");
        }

        status.textContent = "‚úÖ Extraction complete!";
        displayExtractedData(text);
    } catch (err) {
        status.innerHTML = "‚ùå Error: " + err.message;
        console.error(err);
    }
}

// ---- PDF Extractor (with OCR fallback)
async function extractFromPDF(file) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let fullText = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const text = content.items.map(item => item.str).join(" ");
        fullText += text + "\n";
    }

    if (fullText.trim().length === 0) {
        fullText = await ocrFromPDF(file);
    }
    return fullText;
}

// OCR for scanned PDFs
async function ocrFromPDF(file) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let text = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

        const img = canvas.toDataURL("image/png");
        const ocr = await Tesseract.recognize(img, "eng", {
            logger: info => {
                document.getElementById("status").textContent = `üîç OCR in progress... ${info.progress * 100 | 0}%`;
            }
        });
        text += ocr.data.text + "\n";
    }
    return text;
}

// DOCX extraction
async function extractFromDOCX(file) {
    const buffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer: buffer });
    return result.value;
}

// Image extraction
async function extractFromImage(file) {
    const img = URL.createObjectURL(file);
    const result = await Tesseract.recognize(img, "eng", {
        logger: info => {
            document.getElementById("status").textContent = `üîç OCR in progress... ${info.progress * 100 | 0}%`;
        }
    });
    return result.data.text;
}

// ---- Display extracted text & K-level summary ----
function displayExtractedData(text) {
    const output = document.getElementById("output");
    const details = {};

    // Extract student info
    details.college = (text.match(/College\s*Name[:.]?\s*(.+)/i) || [])[1] || "Not found";
    details.class = (text.match(/Class[:.]?\s*(.+)/i) || [])[1] || "Not found";
    details.subjectCode = (text.match(/Subject\s*Code[:.]?\s*([A-Za-z0-9]+)/i) || [])[1] || "Not found";
    details.registerNo = (text.match(/Register\s*No[:.]?\s*(\d+)/i) || [])[1] || "Not found";

    // ---- NEW: Detect K-level answers ----
    const kCounts = { K1:0, K2:0, K3:0, K4:0, K5:0, K6:0 };
    const questionRegex = /Q\s*\d+.*?(K1|K2|K3|K4|K5|K6).*?(‚óè|‚úì|‚úî|filled|tick)/gi;
    let match, questionCount = 0, answered = [];

    while ((match = questionRegex.exec(text)) !== null) {
        questionCount++;
        const k = match[1];
        kCounts[k]++;
        answered.push({ q: questionCount, k });
    }

    const totalAnswered = Object.values(kCounts).reduce((a,b)=>a+b,0);
    const totalQuestions = (text.match(/Q\s*\d+/gi) || []).length;
    const unanswered = Math.max(0, totalQuestions - totalAnswered);

    // ---- OUTPUT UI ----
    output.innerHTML = `
      <div class="details">
        <h3>üìã Student Details</h3>
        <b>College:</b> ${details.college}<br>
        <b>Class:</b> ${details.class}<br>
        <b>Subject Code:</b> ${details.subjectCode}<br>
        <b>Register No:</b> ${details.registerNo}<br>
      </div>

      <div class="klevel">
        <h3>üßÆ K-Level Counter</h3>
        <table>
          <tr><th>K-Level</th><th>Count</th></tr>
          ${Object.entries(kCounts).map(([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("")}
          <tr><td><b>Total Answered</b></td><td><b>${totalAnswered}</b></td></tr>
          <tr><td><b>Unanswered</b></td><td><b>${unanswered}</b></td></tr>
          <tr><td><b>Total Questions</b></td><td><b>${totalQuestions}</b></td></tr>
        </table>
      </div>

      <div class="klevel">
        <h3>üìù Question-wise Detected K-Levels</h3>
        ${answered.length > 0
          ? answered.map(a => `Q${a.q}: <span class='answered'>${a.k}</span>`).join("<br>")
          : "<p class='unanswered'>No K-Level answers detected.</p>"}
      </div>

      <hr>
      <b>Full Extracted Text:</b><br><pre>${text}</pre>
    `;
}
</script>
</body>
</html>
