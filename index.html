<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OMR Reader ‚Äì PDF / Image / DOCX Extractor</title>

<!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>

<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #f6f8fb;
  padding: 20px;
  color: #222;
}
.container {
  max-width: 900px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 15px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  color: #007bff;
}
input[type=file] {
  display: block;
  margin: 15px auto;
  padding: 10px;
}
#status {
  text-align: center;
  color: #444;
  font-weight: bold;
  margin-top: 10px;
}
#output {
  margin-top: 20px;
  white-space: pre-wrap;
  background: #f3f3f3;
  border-radius: 10px;
  padding: 15px;
}
.details {
  background: #e8f4ff;
  border-left: 5px solid #007bff;
  padding: 10px;
  margin-bottom: 10px;
}
.error {
  color: red;
  font-weight: bold;
}
</style>
</head>

<body>
  <div class="container">
    <h1>üìò OMR Reader ‚Äì PDF / Image / DOCX Extractor</h1>
    <p style="text-align:center;">Upload a <b>PDF, DOCX, or Image</b> to extract student details.</p>
    <input type="file" id="fileInput" accept=".pdf,.docx,.jpg,.jpeg,.png">
    <div id="status"></div>
    <div id="output">No file uploaded yet.</div>
  </div>

<script>
document.getElementById("fileInput").addEventListener("change", handleFile);

async function handleFile(event) {
    const file = event.target.files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    const status = document.getElementById("status");
    const output = document.getElementById("output");
    status.textContent = "‚è≥ Processing " + file.name + " ...";
    output.textContent = "";

    try {
        let text = "";
        if (ext === "pdf") text = await extractFromPDF(file);
        else if (ext === "docx") text = await extractFromDOCX(file);
        else if (["jpg", "jpeg", "png"].includes(ext)) text = await extractFromImage(file);
        else throw new Error("Unsupported file type.");

        if (!text || text.trim().length === 0) {
            throw new Error("No text detected in file. Try uploading a clearer image or a text-based PDF.");
        }

        status.textContent = "‚úÖ Extraction complete!";
        displayExtractedData(text);
    } catch (err) {
        status.innerHTML = "‚ùå Error: " + err.message;
        console.error(err);
    }
}

// Extract from PDF (with OCR fallback)
async function extractFromPDF(file) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let fullText = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const text = content.items.map(item => item.str).join(" ");
        fullText += text + "\n";
    }

    if (fullText.trim().length === 0) {
        // OCR fallback
        fullText = await ocrFromPDF(file);
    }
    return fullText;
}

// OCR for scanned PDFs
async function ocrFromPDF(file) {
    const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
    let text = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2 });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport: viewport }).promise;

        const img = canvas.toDataURL("image/png");
        const ocr = await Tesseract.recognize(img, "eng", {
            logger: info => {
                document.getElementById("status").textContent = `üîç OCR in progress... ${info.progress * 100 | 0}%`;
            }
        });
        text += ocr.data.text + "\n";
    }
    return text;
}

// DOCX extraction
async function extractFromDOCX(file) {
    const buffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer: buffer });
    return result.value;
}

// Image extraction
async function extractFromImage(file) {
    const img = URL.createObjectURL(file);
    const result = await Tesseract.recognize(img, "eng", {
        logger: info => {
            document.getElementById("status").textContent = `üîç OCR in progress... ${info.progress * 100 | 0}%`;
        }
    });
    return result.data.text;
}

// Display extracted data
function displayExtractedData(text) {
    const output = document.getElementById("output");
    const details = {};

    details.college = (text.match(/College\s*Name[:.]?\s*(.+)/i) || [])[1] || "Not found";
    details.class = (text.match(/Class[:.]?\s*(.+)/i) || [])[1] || "Not found";
    details.subjectCode = (text.match(/Subject\s*Code[:.]?\s*([A-Za-z0-9]+)/i) || [])[1] || "Not found";
    details.registerNo = (text.match(/Register\s*No[:.]?\s*(\d+)/i) || [])[1] || "Not found";

    output.innerHTML = `
      <div class="details">
        <h3>üìã Student Details Extracted</h3>
        <b>College:</b> ${details.college}<br>
        <b>Class:</b> ${details.class}<br>
        <b>Subject Code:</b> ${details.subjectCode}<br>
        <b>Register No:</b> ${details.registerNo}<br>
      </div>
      <hr>
      <b>Full Extracted Text:</b><br>${text}
    `;
}
</script>
</body>
</html>
